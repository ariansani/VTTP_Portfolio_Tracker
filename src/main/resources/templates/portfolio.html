<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css"
      integrity="sha512-10/jx2EXwxxWqCLX/hHth/vu2KY3jCF70dCQB8TSgNjbCVAC/8vai53GfMDrO2Emgwccf2pJqxct9ehpzG+MTw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      body {
        margin: 4em;
      }
      body.swal2-shown > [aria-hidden="true"] {
        transition: 0.1s filter;
        filter: blur(10px);
      }
    </style>
  </head>
  <body>
    <div style="clear: both; text-align: center">
      <h3 style="display: inline-block; margin: auto">Portfolio Holdings</h3>
      <button
        class="btn btn-lg btn-success"
        aria-label="Enter a ticker symbol"
        id="addBtn"
        name="addBtn"
      >
        Add
      </button>
    </div>
    <table border="1" id="portfolio" class="display">
      <thead>
        <tr>
          <th>Ticker Symbol</th>
          <th>Quantity</th>
          <th>Cost Basis</th>
          <th>Current Price</th>
        </tr>
      </thead>
      <tbody>
        <tr data-th-each="holding : ${holdings}">
          <td data-th-text="${holding.getSymbol}"></td>
          <td data-th-text="${holding.getQuantity}"></td>
          <td data-th-text="${holding.getCostBasis}"></td>
          <td data-th-text="${holding.getCurrentPrice}"></td>
        </tr>
      </tbody>
    </table>

    <form action="/logout" method="get">
      <button class="btn btn-lg btn-danger" type="submit">Logout</button>
    </form>
  </body>
</html>

<script
  src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
  crossorigin="anonymous"
></script>
<script
  type="text/javascript"
  charset="utf8"
  src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.js"
></script>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
  $(document).ready(function () {
    $("#portfolio").DataTable();

    $("#addBtn").on("click", function () {
      (async () => {
        const { value: ticker } = await Swal.fire({
          title: "Enter a stock by their ticker symbol (US)",
          input: "text",
          inputLabel: "Enter Ticker Symbol",
          showCancelButton: true,
          inputValidator: (value) => {
            if (!value) {
              return "You need to write something!";
            }
          },
        });
        let tickerValid = ticker.toUpperCase();
        if (tickerValid) {
          Swal.fire({
            icon: "info",
            title: "Just a moment...",
            text: `Finding price information for : ${tickerValid}`,
            timer: 2600,
            timerProgressBar: true,
            didOpen: () => {
              Swal.showLoading();
            },
          }).then((result) => {
            if (result.dismiss === Swal.DismissReason.timer) {
              searchStockAjax();
            }
          });

          function searchStockAjax() {
            let request = $.ajax({
              type: "POST",
              contentType: "text/plain",
              url: "/search",
              data: tickerValid,
              dataType: "text",
            });

            request.done(function (msg) {
              (async () => {
                const { value: formValues } = await Swal.fire({
                  title: `Current Price for ${tickerValid} : ${msg}`,
                  html:
                    'Quantity <input id="swal-input1" type=number class="swal2-input"><br/>' +
                    'Cost Basis <input id="swal-input2" type=number class="swal2-input">',
                  focusConfirm: false,
                  preConfirm: () => {
                    return [
                      document.getElementById("swal-input1").value,
                      document.getElementById("swal-input2").value,
                    ];
                  },
                });

                if (formValues) {
                  Swal.fire(JSON.stringify(formValues));
                }
              })();
             
            });

            request.fail(function () {
              Swal.fire({
                icon: "error",
                title: "Sorry!",
                text: `Unable to find stock data for ${tickerValid}`,
                confirmButtonColor: "#3085d6",
                confirmButtonText: "Back",
                footer: "Currently we only support US Equities",
              }).then((result) => {
                if (result.isConfirmed) {
                  document.getElementById("addBtn").click();
                }
              });
            }); //end of request fail
          }
        } //end of ticker
      })(); //end of async
    }); //end of addBtn click
  }); //end of document ready
</script>
